# Head 节点：配置免密 SSH，启动 sshd + nv-hostengine；可选跑 mndiag（L20 等不支持 mndiag 时保持 RUN_MNDIAG=false）
# 需配合 ssh-secret、worker deployment 和 services 使用
# L20 用法：保持 RUN_MNDIAG=false，Pod 常驻，kubectl exec 进 head 测试免密与单机命令
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dcgm-mndiag-head
  namespace: dcgm-mndiag
  labels:
    app: dcgm-mndiag
    role: head
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dcgm-mndiag
      role: head
  template:
    metadata:
      labels:
        app: dcgm-mndiag
        role: head
    spec:
      # Pod 网络（Calico 修复后跨节点已通）；head 固定到节点 1
      nodeName: l20-gpu-04
      containers:
        - name: dcgm-mndiag
          image: dcgm-mndiag:latest   # 本地构建用此名即可；推送到仓库时改为完整地址
          imagePullPolicy: Never     # 使用本地镜像时用 Never；从仓库拉取时改为 IfNotPresent
          command:
            - /bin/bash
            - -c
            - |
              set -e
              mkdir -p /root/.ssh
              chmod 700 /root/.ssh
              cp /mnt-ssh/id_rsa /root/.ssh/id_rsa
              cp /mnt-ssh/id_rsa.pub /root/.ssh/id_rsa.pub
              chmod 600 /root/.ssh/id_rsa /root/.ssh/id_rsa.pub
              cat /mnt-ssh/id_rsa.pub >> /root/.ssh/authorized_keys 2>/dev/null || true
              if [ ! -s /root/.ssh/authorized_keys ]; then
                cp /mnt-ssh/id_rsa.pub /root/.ssh/authorized_keys
              fi
              chmod 600 /root/.ssh/authorized_keys
              echo -e 'Host dcgm-mndiag-worker dcgm-mndiag-head\n  StrictHostKeyChecking accept-new\n  UserKnownHostsFile /root/.ssh/known_hosts' > /root/.ssh/config
              chmod 600 /root/.ssh/config
              ssh-keygen -R dcgm-mndiag-worker -R dcgm-mndiag-head -f /root/.ssh/known_hosts 2>/dev/null || true
              for i in 1 2 3 4 5 6 7 8 9 10; do ssh-keyscan -H dcgm-mndiag-head dcgm-mndiag-worker 2>/dev/null >> /root/.ssh/known_hosts && break; sleep 3; done
              /usr/sbin/sshd
              nv-hostengine -b 2>/dev/null || true
              sleep 2
              if [ "${RUN_MNDIAG}" = "true" ]; then
                exec dcgmi mndiag --hostList "dcgm-mndiag-head;dcgm-mndiag-worker" -j
              else
                echo "RUN_MNDIAG not true. Exec in and try: ssh dcgm-mndiag-worker hostname; ssh dcgm-mndiag-worker nvidia-smi; dcgmi discovery -n"
                exec sleep infinity
              fi
          env:
            - name: DCGM_MNDIAG_MPIRUN_PATH
              value: "/usr/bin/mpirun"
            - name: RUN_MNDIAG
              value: "false"
          resources:
            limits:
              nvidia.com/gpu: "1"  # 按实际 GPU 数量调整
          volumeMounts:
            - name: ssh-keys
              mountPath: /mnt-ssh
              readOnly: true
      volumes:
        - name: ssh-keys
          secret:
            secretName: dcgm-mndiag-ssh
            defaultMode: 0600
